disabled_plugins = [
  "io.containerd.snapshotter.v1.aufs",
  "io.containerd.snapshotter.v1.btrfs",
  "io.containerd.snapshotter.v1.zfs",
  "io.containerd.snapshotter.v1.native",
  "io.containerd.snapshotter.v1.overlayfs",
  "io.containerd.snapshotter.v1.devmapper"
]

imports = [
  "/etc/containerd/conf.d/*.toml",
  "/usr/share/spin-stack/config/containerd/conf.d/*.toml"
]

oom_score = 0
root = "/var/lib/spin-stack/containerd"
state = "/run/spin-stack/containerd"
version = 3

[grpc]
address = "/var/run/spin-stack/containerd.sock"
gid = 0
uid = 0

[debug]
  level = "debug"

[metrics]
address = ""
grpc_histogram = false

# External spin-erofs snapshotter (EROFS-based)
#
# Provides two services via a single external process:
#   - spin-erofs: Snapshot service that stores image layers as EROFS filesystems
#   - spin-erofs-diff: Diff service that efficiently applies/compares layers
#
# The snapshotter mounts EROFS layers directly and returns standard overlay mounts
# with real paths - no mount-manager plugin required.
[proxy_plugins]
  [proxy_plugins.spin-erofs]
    type = "snapshot"
    address = "/run/spin-stack/erofs-snapshotter/snapshotter.sock"

  [proxy_plugins.spin-erofs-diff]
    type = "diff"
    address = "/run/spin-stack/erofs-snapshotter/snapshotter.sock"

[plugins]
"io.containerd.internal.v1.tracing" = { }
"io.containerd.tracing.processor.v1.otlp" = { }

  [plugins."io.containerd.cri.v1.images"]
  concurrent_layer_fetch_buffer = 0
  disable_snapshot_annotations = true
  discard_unpacked_layers = false
  image_pull_progress_timeout = "5m0s"
  image_pull_with_sync_fs = false
  max_concurrent_downloads = 10
  snapshotter = "spin-erofs"
  stats_collect_period = 10
  use_local_image_pull = false

    [plugins."io.containerd.cri.v1.images".pinned_images]
    sandbox = "registry.k8s.io/pause:3.10.1"

    [plugins."io.containerd.cri.v1.images".registry]
    config_path = "/usr/share/spin-stack/config/containerd/certs.d:/usr/share/spin-stack/config/docker/certs.d"

  [plugins."io.containerd.cri.v1.runtime"]
  cdi_spec_dirs = [ "/usr/share/spin-stack/config/cdi", "/var/run/cdi" ]
  enable_cdi = true
  enable_selinux = false
  enable_unprivileged_icmp = true
  enable_unprivileged_ports = true
  tolerate_missing_hugetlb_controller = true

    [plugins."io.containerd.cri.v1.runtime".cni]
    bin_dir = ""
    bin_dirs = [ "/usr/share/spin-stack/libexec/cni" ]
    conf_dir = "/usr/share/spin-stack/config/cni/net.d"
    conf_template = ""
    ip_pref = ""
    max_conf_num = 1
    setup_serially = false
    use_internal_loopback = false

    [plugins."io.containerd.cri.v1.runtime".containerd]
    default_runtime_name = "runc"
    ignore_blockio_not_enabled_errors = false
    ignore_rdt_not_enabled_errors = false

[plugins."io.containerd.cri.v1.runtime".containerd.runtimes.runc]
runtime_type = "io.containerd.runc.v2"
sandboxer = "podsandbox"

  [plugins."io.containerd.cri.v1.runtime".containerd.runtimes.runc.options]
  SystemdCgroup = true

  [plugins."io.containerd.gc.v1.scheduler"]
  deletion_threshold = 0
  mutation_threshold = 100
  pause_threshold = 0.02
  schedule_delay = "0s"
  startup_delay = "100ms"

  [plugins."io.containerd.grpc.v1.cri"]
  disable_tcp_service = true
  enable_tls_streaming = false

  [plugins."io.containerd.internal.v1.opt"]
  path = "/usr/share/spin-stack/opt"

  [plugins."io.containerd.nri.v1.nri"]
  disable = false
  disable_connections = false
  plugin_config_path = "/usr/share/spin-stack/config/nri/conf.d"
  plugin_path = "/usr/share/spin-stack/nri/plugins"
  plugin_registration_timeout = "5s"
  plugin_request_timeout = "2s"
  socket_path = "/var/run/spin-stack/nri/nri.sock"

    [plugins."io.containerd.nri.v1.nri".default_validator]
    enable = false

  [plugins."io.containerd.runtime.v2.task"]
  platforms = [ "linux/amd64" ]

  [plugins."io.containerd.service.v1.diff-service"]
  default = [ "spin-erofs-diff", "walking" ]
  sync_fs = false

  [plugins."io.containerd.transfer.v1.local"]
  check_platform_supported = false
  concurrent_layer_fetch_buffer = 0
  config_path = ""
  max_concurrent_downloads = 10
  max_concurrent_unpacks = 10
  max_concurrent_uploaded_layers = 10

    [[plugins."io.containerd.transfer.v1.local".unpack_config]]
    platform = "linux/amd64"
    snapshotter = "spin-erofs"
    differ = "spin-erofs-diff"

[timeouts]
"io.containerd.timeout.bolt.open" = "0s"
"io.containerd.timeout.cri.defercleanup" = "1m0s"
"io.containerd.timeout.metrics.shimstats" = "2s"
"io.containerd.timeout.shim.cleanup" = "60s"
"io.containerd.timeout.shim.load" = "5s"
"io.containerd.timeout.shim.shutdown" = "60s"
"io.containerd.timeout.task.state" = "2s"
