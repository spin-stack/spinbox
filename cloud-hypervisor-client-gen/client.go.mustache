// Code generated by cloud-hypervisor-client-gen. DO NOT EDIT.

package cloudhypervisor

import (
    "bytes"
    "context"
    "encoding/json"
    "fmt"
    "io"
    "net"
    "net/http"
    "time"
)

// CloudHypervisorClient provides a client for interacting with the Cloud Hypervisor API
// through a Unix domain socket connection.
type CloudHypervisorClient struct {
    httpClient *http.Client
}

func NewCloudHypervisorClient(socketPath string) *CloudHypervisorClient {
    return &CloudHypervisorClient{
        httpClient: &http.Client{
            Timeout: 30 * time.Second,
            Transport: &http.Transport{
                DialContext: func(ctx context.Context, network, addr string) (net.Conn, error) {
                    return net.Dial("unix", socketPath)
                },
                DisableKeepAlives: true,
            },
        },
    }
}

{{#endpoints}}
{{#desc}}// {{desc}}{{/desc}}
func (c *CloudHypervisorClient) {{name}}(ctx context.Context{{#arg}}, arg {{arg}}{{/arg}}) {{#ret}}({{ret}}, {{/ret}}error{{#ret}}){{/ret}} {
    {{#arg}}
    reqBody, err := json.Marshal(arg)
    if err != nil {
        return {{#ret}}nil, {{/ret}}fmt.Errorf("encode request: %w", err)
    }
    {{/arg}}

    req, err := http.NewRequestWithContext(ctx, "{{method}}", "http://localhost/api/v1{{path}}", {{#arg}}bytes.NewBuffer(reqBody){{/arg}}{{^arg}}nil{{/arg}})
    if err != nil {
        return {{#ret}}nil, {{/ret}}fmt.Errorf("build request: %w", err)
    }

    resp, err := c.httpClient.Do(req)
    if err != nil {
        return {{#ret}}nil, {{/ret}}fmt.Errorf("do request: %w", err)
    }

    // Handle error responses before setting up defer
    if resp.StatusCode >= 400 {
        body, _ := io.ReadAll(resp.Body)
        resp.Body.Close()
        return {{#ret}}nil, {{/ret}}fmt.Errorf("request failed: %d %s: %s", resp.StatusCode, http.StatusText(resp.StatusCode), string(body))
    }
    defer resp.Body.Close()

    {{#ret}}
    var ret {{ret}}
    if err := json.NewDecoder(resp.Body).Decode(&ret); err != nil {
        return nil, fmt.Errorf("decode response: %w", err)
    }
    {{/ret}}

    return {{#ret}}ret, {{/ret}}nil
}

{{/endpoints}}

{{#types}}
{{#desc}}// {{desc}}{{/desc}}
type {{name}} struct {
{{#fields}}
    {{name}} {{type}} `json:"{{key}}{{^required}},omitempty{{/required}}"`
{{/fields}}
}

{{/types}}
