#!/usr/bin/env bash




#
# Downloads and installs protobuf (local bin/include)
#
set -eu -o pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BIN_DIR="${ROOT_DIR}/bin"
PROTOBUF_VERSION=3.20.1
PROTOBUF_DIR=$(mktemp -d)
GOOS=$(go env GOOS)
GOARCH=$(go env GOARCH)

case "${GOOS}-${GOARCH}" in
  darwin-amd64)  TARGET="osx-x86_64" ;;
  darwin-arm64)  TARGET="osx-aarch_64" ;;
  linux-amd64)   TARGET="linux-x86_64" ;;
  linux-arm64)   TARGET="linux-aarch_64" ;;
  linux-386)     TARGET="linux-x86_32" ;;
  linux-ppc64le) TARGET="linux-ppcle_64" ;;
  windows-amd64) TARGET="win64" ;;
  windows-386)   TARGET="win32" ;;
  *)
    echo "Unsupported platform: ${GOOS}-${GOARCH}"
    echo "Please install protoc manually from:"
    echo "https://github.com/protocolbuffers/protobuf/releases"
    exit 1
    ;;
esac

mkdir -p "${BIN_DIR}"
curl -sL -o "${PROTOBUF_DIR}/protobuf.zip" \
  "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOBUF_VERSION}/protoc-${PROTOBUF_VERSION}-${TARGET}.zip"
unzip -qo "${PROTOBUF_DIR}/protobuf.zip" -d "${PROTOBUF_DIR}/protobuf"
cp "${PROTOBUF_DIR}/protobuf/bin/protoc" "${BIN_DIR}/protoc"
rm -rf "${BIN_DIR}/include"
cp -r "${PROTOBUF_DIR}/protobuf/include" "${BIN_DIR}/include"
rm -rf "${PROTOBUF_DIR}"

# Download status.proto locally for builds that don't rely on /usr/local/include.
mkdir -p "${BIN_DIR}/include/google/rpc"
curl -sL \
  https://raw.githubusercontent.com/grpc/grpc/v1.45.2/src/proto/grpc/status/status.proto \
  -o "${BIN_DIR}/include/google/rpc/status.proto"

# Install protobuf includes system-wide if possible.
if [ -d /usr/local/include ] && [ -w /usr/local/include ]; then
  cp -r "${BIN_DIR}/include/google" /usr/local/include/
  mkdir -p /usr/local/include/google/rpc
  cp "${BIN_DIR}/include/google/rpc/status.proto" /usr/local/include/google/rpc/status.proto
  echo "Protobuf includes installed to /usr/local/include"
else
  echo "Cannot write to /usr/local/include - sudo required"
  echo "Run:"
  echo "  sudo mkdir -p /usr/local/include"
  echo "  sudo cp -r ${BIN_DIR}/include/google /usr/local/include/"
  echo "  sudo mkdir -p /usr/local/include/google/rpc"
  echo "  sudo cp ${BIN_DIR}/include/google/rpc/status.proto /usr/local/include/google/rpc/status.proto"
fi
