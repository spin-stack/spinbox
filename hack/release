#!/usr/bin/env bash

#
# Create release tarball with proper directory structure
#
set -eu -o pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
OUTPUT_DIR="${ROOT_DIR}/_output"

cd "${ROOT_DIR}"

echo "Creating release tarball..."

VERSION="${VERSION:-$(git describe --tags --always --dirty 2>/dev/null || echo "dev")}"
RELEASE_NAME="qemubox-${VERSION}-linux-x86_64"
RELEASE_DIR="${OUTPUT_DIR}/release/${RELEASE_NAME}"

rm -rf "${OUTPUT_DIR}/release"
mkdir -p "${RELEASE_DIR}/usr/share/qemubox/bin"
mkdir -p "${RELEASE_DIR}/usr/share/qemubox/kernel"
mkdir -p "${RELEASE_DIR}/usr/share/qemubox/config"

echo "Copying artifacts to release structure..."

artifacts=(
  "${OUTPUT_DIR}/qemubox-kernel-x86_64:kernel:qemubox-kernel-x86_64"
  "${OUTPUT_DIR}/qemubox-initrd:kernel:qemubox-initrd"
  "${OUTPUT_DIR}/containerd-shim-qemubox-v1:bin:containerd-shim-qemubox-v1"
  "${OUTPUT_DIR}/vminitd:bin:vminitd"
)

for entry in "${artifacts[@]}"; do
  IFS=":" read -r src rel dest <<< "${entry}"
  if [ -f "${src}" ]; then
    cp "${src}" "${RELEASE_DIR}/usr/share/qemubox/${rel}/${dest}"
    echo "  ok: ${dest}"
  fi
done

echo "Adding QEMU binaries and firmware..."
if [ -f "${OUTPUT_DIR}/bin/qemu-system-x86_64" ]; then
  cp "${OUTPUT_DIR}/bin/qemu-system-x86_64" "${RELEASE_DIR}/usr/share/qemubox/bin/"
  chmod +x "${RELEASE_DIR}/usr/share/qemubox/bin/qemu-system-x86_64"
  echo "  ok: qemu-system-x86_64"
else
  echo "  warn: qemu-system-x86_64 not found - skipping"
fi

if [ -d "${OUTPUT_DIR}/share/qemubox/qemu" ]; then
  mkdir -p "${RELEASE_DIR}/usr/share/qemubox/qemu"
  cp -r "${OUTPUT_DIR}/share/qemubox/qemu/"* "${RELEASE_DIR}/usr/share/qemubox/qemu/"
  echo "  ok: QEMU firmware files"
else
  echo "  warn: QEMU firmware files not found - skipping"
fi

missing_qemu_firmware=0
for firmware in bios-256k.bin kvmvapic.bin vgabios-stdvga.bin; do
  if [ ! -f "${RELEASE_DIR}/usr/share/qemubox/qemu/${firmware}" ]; then
    echo "ðŸ‘¹ Error: missing QEMU firmware file ${firmware} in release"
    missing_qemu_firmware=1
  fi
done

if [ "${missing_qemu_firmware}" -ne 0 ]; then
  if [ -d "${OUTPUT_DIR}/share/qemubox/qemu" ]; then
    echo "Contents of ${OUTPUT_DIR}/share/qemubox/qemu:"
    ls -la "${OUTPUT_DIR}/share/qemubox/qemu" || true
  fi
  exit 1
fi

echo "Copying configuration files..."
cp -r deploy/config/* "${RELEASE_DIR}/usr/share/qemubox/config/"
echo "  ok: config files (containerd, cni)"

echo "Copying qemubox config example..."
mkdir -p "${RELEASE_DIR}/usr/share/qemubox/config/qemubox"
cp examples/config.json "${RELEASE_DIR}/usr/share/qemubox/config/qemubox/config.json"
echo "  ok: qemubox config.json example"

echo "Copying systemd services..."
mkdir -p "${RELEASE_DIR}/usr/share/qemubox/systemd"
cp deploy/systemd/*.service "${RELEASE_DIR}/usr/share/qemubox/systemd/"
echo "  ok: systemd services"

echo "Copying install scripts..."
cp deploy/install.sh "${RELEASE_DIR}/"
cp deploy/uninstall.sh "${RELEASE_DIR}/"
chmod +x "${RELEASE_DIR}/install.sh"
chmod +x "${RELEASE_DIR}/uninstall.sh"
echo "  ok: install/uninstall scripts"

echo "Downloading nerdctl-full (includes containerd, runc, nerdctl, ctr)..."
NERDCTL_VERSION="${NERDCTL_VERSION:-2.2.1}"
NERDCTL_URL="https://github.com/containerd/nerdctl/releases/download/v${NERDCTL_VERSION}/nerdctl-full-${NERDCTL_VERSION}-linux-amd64.tar.gz"
NERDCTL_TARBALL="${OUTPUT_DIR}/nerdctl-full-${NERDCTL_VERSION}-linux-amd64.tar.gz"

if [ ! -f "${NERDCTL_TARBALL}" ]; then
  curl -L -o "${NERDCTL_TARBALL}" "${NERDCTL_URL}"
fi

echo "Extracting nerdctl-full components (containerd, containerd-shim-runc-v2, nerdctl, ctr, runc)..."
tar -xzf "${NERDCTL_TARBALL}" -C "${RELEASE_DIR}/usr/share/qemubox/" \
  bin/containerd \
  bin/containerd-shim-runc-v2 \
  bin/nerdctl \
  bin/ctr \
  bin/runc
echo "  ok: containerd, containerd-shim-runc-v2, runc, ctr, nerdctl"

mkdir -p "${RELEASE_DIR}/usr/share/qemubox/libexec/cni"
tar -xzf "${NERDCTL_TARBALL}" -C "${RELEASE_DIR}/usr/share/qemubox/libexec/cni" --strip-components=2 \
  libexec/cni/bandwidth \
  libexec/cni/bridge \
  libexec/cni/dhcp \
  libexec/cni/firewall \
  libexec/cni/host-device \
  libexec/cni/host-local \
  libexec/cni/loopback \
  libexec/cni/portmap \
  libexec/cni/ptp \
  libexec/cni/tuning
echo "  ok: CNI plugins"

echo "Building tc-redirect-tap CNI plugin..."
TC_REDIRECT_TAP_DIR="${OUTPUT_DIR}/tc-redirect-tap"
if [ ! -d "${TC_REDIRECT_TAP_DIR}" ]; then
  git clone --depth=1 https://github.com/awslabs/tc-redirect-tap "${TC_REDIRECT_TAP_DIR}"
fi

(cd "${TC_REDIRECT_TAP_DIR}" && \
  env GOWORK=off CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags '-extldflags "-static" -s -w' \
    -tags 'osusergo netgo static_build' \
    -o tc-redirect-tap ./cmd/tc-redirect-tap)

cp "${TC_REDIRECT_TAP_DIR}/tc-redirect-tap" \
  "${RELEASE_DIR}/usr/share/qemubox/libexec/cni/"
chmod +x "${RELEASE_DIR}/usr/share/qemubox/libexec/cni/tc-redirect-tap"
echo "  ok: tc-redirect-tap CNI plugin"

echo "Downloading nexus-erofs-snapshotter and erofs tools..."
NEXUS_EROFS_VERSION="${NEXUS_EROFS_VERSION:-v20250106.02}"
NEXUS_EROFS_BASE_URL="https://github.com/aledbf/nexus-erofs/releases/download/${NEXUS_EROFS_VERSION}"

NEXUS_EROFS_BINARIES=(
  "nexus-erofs-snapshotter-linux-amd64:nexus-erofs-snapshotter"
  "dump.erofs-linux-amd64:dump.erofs"
  "fsck.erofs-linux-amd64:fsck.erofs"
  "mkfs.erofs-linux-amd64:mkfs.erofs"
)

for entry in "${NEXUS_EROFS_BINARIES[@]}"; do
  IFS=":" read -r src dest <<< "${entry}"
  bin_path="${OUTPUT_DIR}/${src}"

  if [ ! -f "${bin_path}" ]; then
    curl -L -o "${bin_path}" "${NEXUS_EROFS_BASE_URL}/${src}"
  fi

  cp "${bin_path}" "${RELEASE_DIR}/usr/share/qemubox/bin/${dest}"
  chmod +x "${RELEASE_DIR}/usr/share/qemubox/bin/${dest}"
  echo "  ok: ${dest}"
done

echo "Creating tarball..."
cd "${OUTPUT_DIR}/release"
tar czf "${RELEASE_NAME}.tar.gz" "${RELEASE_NAME}"
cd "${ROOT_DIR}"

echo "Release created: ${OUTPUT_DIR}/release/${RELEASE_NAME}.tar.gz"
echo ""
echo "Installation:"
echo "  tar xzf ${RELEASE_NAME}.tar.gz"
echo "  cd ${RELEASE_NAME}"
echo "  sudo ./install.sh"
echo ""
echo "Uninstallation:"
echo "  sudo ./uninstall.sh"
